stages:
  - prepare
  - build
  - upload

variables:
  CONTAINER_NAME: "pos_container"

  # Define the rootfs path with unique identifiers for each namespace/project
  ROOTFS_PATH: "/mnt/gitlab-rootfs/$CI_PROJECT_NAMESPACE/$CI_PROJECT_NAME"

pos:
  stage: build
  script:
    - echo "Creating persistent directory on the runner host at $ROOTFS_PATH"
    - mkdir -p $ROOTFS_PATH
    - docker build . -t $CONTAINER_NAME
    - docker run --privileged -v $ROOTFS_PATH:/root/pos/rootfs -t --env PATH="/opt/toolchains/gcc-linaro-11.3.1-2022.06-x86_64_arm-linux-gnueabihf/bin:$PATH" $CONTAINER_NAME sh -c ./build_rootfs.sh
    - echo "Copying file from the Docker image..."
    - docker run --rm -v "$(pwd):/mnt/host" -v $ROOTFS_PATH:/root/pos/rootfs -t $CONTAINER_NAME sh -c "cp /root/pos/rootfs/board/virt32/rootfs.cpio /mnt/host/"
    - cp rootfs.cpio $ROOTFS_PATH
  tags:
    - runners-server,shell

upload_artifact:
  stage: upload
  script:
    - echo "Uploading rootfs.cpio artifact"
    - cp $ROOTFS_PATH/rootfs.cpio .
  artifacts:
    paths:
      - rootfs.cpio
    expire_in: never
  tags:
    - runners-server,shell

clean:
  stage: prepare
  script:
    - docker run --rm -v "$(pwd):/mnt/host" -v $ROOTFS_PATH:/root/pos/rootfs -t $CONTAINER_NAME sh -c "rm -rf /root/pos/rootfs/*"
  when: manual
  tags:
    - runners-server,shell
  
